Changing the Format of Data in Memcached
----------------------------------------
Project Clearwater makes heavy use of [memcached](http://memcached.org/) as a distributed data store that is shared between all nodes in a cluster (e.g. by every Sprout in a deployment). This allows Clearwater nodes to be transaction stateful rather than dialog stateful, which in turn allows us to scale to arbitrarily large deployments. Over the next few releases we are changing the format of the data stored in memcached. This blog post explains why we are doing this, how the migration is going to work, and what it means for you as a user of Project Clearwater.

**Why are we doing this?** Currently almost all data we store in memcached is in a custom binary format. This is really simple and easy to convert to/from C++ objects, but it is not very extensible. The problem is that there is no way to spot when one object in a record ends and another one begins. This is fine if the object has a fixed size and shape (e.g. it is always two integers then a string), but adding a new field to an object is difficult. This makes it hard to add features that require storing new information in existing memcached records. We could have solved this problem by adding a “version” field to every record, or by adding some sort of “end of object” marker to the binary format. Instead we decided to change to an industry standard format that is naturally extensible. We have settled on [JSON](http://en.wikipedia.org/wiki/JSON). Extending a JSON object is easy – you just add a new attribute. What’s more JSON is human readable (easy to debug), reasonably size-efficient, and reasonably quick to encode and decode. As such it’s a good fit for us.

**How does migration work?** Even though we’re changing the format of a lot of data, we want to roll out the change in a way that wouldn’t have a negative impact on existing deployments. If you want to, and you have a fault-tolerant deployment, you will be able to upgrade your deployment seamlessly, in a way that does not impact active registrations and calls. To achieve this we are first enhancing the nodes that use memcached (Sprout, Ralf and Memento) to be able to read the new JSON format. However they will still write data in the old binary format. This is crucial for ensuring seamless upgrade. Take Sprout for example – half way through an upgrade some of your Sprouts will be running the new code and the rest running the old code, and they need to be able to read each other’s data (remember memcached is used by all nodes in the cluster). As the old Sprouts can only **read** the old format, the new Sprouts must only **write** the old format. The next stage is to switch the Sprout nodes to write JSON. This involves upgrading them again. After the upgrade the data in memcached is still in the old format, but records created or modified by upgraded nodes will be rewritten to JSON. Eventually all records will be migrated to JSON, as all data we store in memcached expires after a certain time unless it is modified. How long it takes to migrate all the data depends on the data in question: for Sprout it is the deployment’s maximum registration time (defaults to 5 minutes). For Ralf it is session refresh time. Memento’s records will be migrated in approximately 1 minute.

**What does this mean for your Clearwater Deployment?** Over the next few releases we will be enhancing Sprout, Ralf and Memento to be able to read the new JSON format. There will be at least one release where they can all read both formats, and all write in binary. They will switch to writing data as JSON in the next release. If you don’t require seamless upgrade this has no effect on you – continue to upgrade as normal. However if you do require seamless upgrade, then you **must** upgrade your deployment to the release where all nodes can read both formats but write binary. We refer to this as the “checkpoint” release. Once you’ve upgraded to the checkpoint release, you are free to upgrade to future releases as you wish. Keep an eye on the Project Clearwater release notes – these will tell you which release is the checkpoint.
